# DesignCanvas ロジック仕様書

`frontend/src/components/DesignCanvas.jsx` は、アセット（家具や部屋の形状）の幾何学的な編集を行うための主要なコンポーネントです。
このドキュメントでは、ユーザー操作（マウスイベント）がどのように処理され、状態が遷移するかを説明します。

## 概要

DesignCanvas は、SVG を使用してシェイプ（矩形、楕円、多角形など）を描画し、マウス操作によってそれらを変形・移動させることができます。
操作の状態管理には、React の `useState`（再描画用）と `useRef`（イベントハンドラ内での即時参照用）を組み合わせて使用しています。

## 座標系

内部データ（ストアおよび `localAsset`）は **デカルト座標系（Y-Up: Y軸が上向き）** を使用しています。
一方、SVG の描画は **スクリーン座標系（Y-Down: Y軸が下向き）** です。
そのため、描画時およびマウスイベントの処理時に、Y軸の変換（`toSvgY` / `toCartesianY`）が行われます。

## インタラクションモード

ユーザーのマウス操作（`onPointerDown`）によって、`dragRef.current.mode` にモードが設定され、`onPointerMove` でそのモードに応じた処理が実行されます。

### 1. アイドル (Idle)
- **状態**: `mode: 'idle'`
- **説明**: 何も操作していない状態。

### 2. パニング (Panning)
- **トリガー**: マウス中ボタン（ホイールクリック）。
- **処理**:
  - `onDown`: 開始位置 (`sx`, `sy`) と現在のビュー状態 (`vx`, `vy`) を記録。
  - `onMove`: 現在のマウス位置との差分を計算し、`viewState`（キャンバスの表示位置）を更新します。

### 3. 矩形選択 (Marquee)
- **トリガー**: 何もないところを左クリック。
- **処理**:
  - `onDown`: 開始位置を記録。`Ctrl` または `Meta` キーが押されていない場合、現在の選択を解除。
  - `onMove`: 矩形領域（Marquee）を描画し、その領域に含まれるシェイプ（エンティティ）を計算して選択状態にします。
  - **判定ロジック**: シェイプの中心点が矩形内に含まれるかどうかで判定。

### 4. シェイプ移動 (DraggingShape)
- **トリガー**: 選択されたシェイプをドラッグ。
- **処理**:
  - `onDown`: 選択された全てのシェイプの初期位置を記録。スナップ計算用のアンカー位置も記録。
  - `onMove`: マウス移動量を計算し、選択された全てのシェイプに適用。
    - **スナップ**: `Shift` キーが押されていない場合、グリッド（`SNAP_UNIT`）にスナップします。
  - `onUp`: 移動終了後、新しい位置でアセットの境界（Bounds）を再計算し、確定します。

### 5. リサイズ (Resizing)
- **トリガー**: シェイプの周囲にあるリサイズハンドル（矩形・円の場合）をドラッグ。
- **モード**: `both` (縦横), `width` (横のみ), `height` (縦のみ)。
- **処理**:
  - `onDown`: 対象シェイプの初期サイズ (`w`, `h`) を記録。
  - `onMove`: マウス移動量に応じてサイズを更新。`Shift` キーなしでスナップ適用。最小サイズ（10px）制限あり。

### 6. ハンドル操作 (DraggingHandle)
- **トリガー**: 多角形（Polygon）のベジェ曲線ハンドルなどをドラッグ。
- **処理**:
  - `onDown`: 対象ポイントとハンドルのインデックスを記録。
  - `onMove`: ハンドルの座標を更新。

### 7. 頂点移動 (DraggingPoint)
- **トリガー**: 多角形の頂点をドラッグ。
- **処理**:
  - `onDown`: 対象ポイントの座標を記録。
  - `onMove`: 頂点座標を更新。スナップ適用。多角形の場合、全体の Bounds (`x`, `y`, `w`, `h`) も同時に更新されます。

### 8. 角度変更 (DraggingAngle)
- **トリガー**: 円弧（Arc）などの開始角・終了角ハンドルをドラッグ。
- **処理**:
  - `onDown`: 中心点（スクリーン座標）を計算して記録。
  - `onMove`: 中心点に対するマウスの角度を計算し、`startAngle` または `endAngle` を更新。15度単位のスナップあり（Shiftで解除）。

### 9. 回転 (DraggingRotation)
- **トリガー**: 回転ハンドルをドラッグ。
- **処理**:
  - `onDown`: 中心点と、開始時のマウス角度、初期回転角を記録。
  - `onMove`: マウスの角度変化量を計算し、初期回転角に加算して新しい回転角を設定。15度単位のスナップあり。

### 10. 半径変更 (DraggingRadius)
- **トリガー**: 楕円（Ellipse）の半径ハンドルをドラッグ。
- **処理**:
  - `onMove`: マウス移動量（X軸方向）を半径（`rx` または `ry`）に加算。

## データ更新フロー

1. **Local State (`localAsset`)**:
   - `onMove` 中は、パフォーマンスのためにコンポーネントローカルな state (`localAsset`) のみを更新し、再描画を行います。
2. **Global Store (`setLocalAssets`)**:
   - `onUp`（マウスボタンを離した時）に初めて、変更をグローバルな Zustand ストア（および親コンポーネントから渡された `setLocalAssets`）にコミットします。
   - これにより、Undo/Redo の履歴が作成されます（ドラッグ中の微細な更新ごとに履歴が作られるのを防ぐため）。

## 境界ボックス (Bounds) の再計算

移動や変形が完了した際（`onUp`）、`calculateAssetBounds` 関数が呼び出されます。
これにより、複数のシェイプを含むグループ全体のバウンディングボックス（`boundX`, `boundY`, `w`, `h`）が再計算され、アセットの配置基準点が更新されます。
